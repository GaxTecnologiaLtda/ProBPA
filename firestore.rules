rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    ///////////////////////////////////////////
    // 柏 1. Funﾃｧﾃｵes auxiliares de seguranﾃｧa
    ///////////////////////////////////////////

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isMasterOf(entityId) {
      return request.auth != null
          && request.auth.token.role == "MASTER"
          && request.auth.token.entityId == entityId;
    }

    function isCoordinationOf(entityId) {
      return request.auth != null
          && request.auth.token.role == "COORDENAﾃﾃグ"
          && request.auth.token.entityId == entityId;
    }

    function isSubsedeOf(entityId) {
      return request.auth != null
          && request.auth.token.role == "SUBSEDE"
          && request.auth.token.entityId == entityId;
    }

    ///////////////////////////////////////////
    // 柏 2. Coleﾃｧﾃ｣o ENTITIES (Admin + Master + Coordenaﾃｧﾃ｣o + Subsede)
    // /entities/{entityId}
    ///////////////////////////////////////////

    match /entities/{entityId} {

      // ADMIN pode tudo
      allow read, write: if isAdmin();

      // MASTER pode ver e editar apenas sua prﾃｳpria entidade
      allow read, write: if isMasterOf(entityId);

      // COORDENAﾃﾃグ pode ver apenas sua prﾃｳpria entidade
      allow read: if isCoordinationOf(entityId);

      // SUBSEDE pode ver apenas sua prﾃｳpria entidade
      allow read: if isSubsedeOf(entityId);

      // PROFESSIONAL pode ler sua prﾃｳpria entidade (necessﾃ｡rio para determinar tipo)
      allow read: if request.auth != null 
                  && request.auth.token.role == "PROFESSIONAL" 
                  && request.auth.token.entityId == entityId;
      
      // PUBLIC REGISTRATION: Allow read of minimal entity info
      allow read: if true; 

      // 柏 ACTIONS (Subcollection)
      match /actions/{actionId} {
        // Master: Full Access
        allow read, write: if isMasterOf(entityId);
        
        // Coordenaﾃｧﾃ｣o: Read/Write (if delegated? Requirement says "Apenas MASTER cria", so Read Only for others?)
        // Requirement: "Apenas MASTER cria Acoes e Programas"
        allow read: if isCoordinationOf(entityId);
        
        // Subsede: Read Only (Everything or just linked? Usually all entity actions are visible if global, 
        // but if we want to restrict to municipalityId... User didn't specify strict read restriction, just create restriction. 
        // Let's allow read for all entity actions for now to be safe, or scope it if issues arise.)
        allow read: if isSubsedeOf(entityId);

        // Professional: Read Only
        allow read: if request.auth.token.role == "PROFESSIONAL" && request.auth.token.entityId == entityId;

        // Subcollection: PRODUCTION
        match /production/{prodId} {
            // Who can register production? 
            // Usually any professional or coordination/master.
            allow read, write: if isMasterOf(entityId)
                               || isCoordinationOf(entityId)
                               || isSubsedeOf(entityId)
                               // Professional can register their own production or generally add?
                               // Production form has "Patient" and "Procedure". Doesn't strictly link to "Professional" field in doc?
                               // Let's allow Professionals to read/write.
                               || (request.auth.token.role == "PROFESSIONAL" && request.auth.token.entityId == entityId);
        }
      }
      
      // 柏 NOTIFICATIONS (Subcollection)
      match /notifications/{notificationId} {
          // Read: Entity Staff
          allow read: if isAdmin() 
                      || isMasterOf(entityId)
                      || isCoordinationOf(entityId)
                      || isSubsedeOf(entityId);
          
          // Update (Mark as read): Entity Staff
          allow update: if isAdmin() 
                        || isMasterOf(entityId)
                        || isCoordinationOf(entityId)
                        || isSubsedeOf(entityId);

          // Delete: Admin/Master
          allow delete: if isAdmin() || isMasterOf(entityId);

          // Create: Public (Triggers)
          allow create: if true;
      }
    }


    ///////////////////////////////////////////
    // 柏 3. Subcoleﾃｧﾃ｣o MASTERS DE CADA ENTIDADE
    // /entities/{entityId}/masters/{uid}
    ///////////////////////////////////////////

    match /entities/{entityId}/masters/{uid} {

      // ADMIN pode gerenciar usuﾃ｡rios mestre
      allow read, write, delete: if isAdmin();

      // MASTER pode apenas *ler* seus prﾃｳprios dados
      allow read: if isMasterOf(entityId) && request.auth.uid == uid;

      // MASTER nunca pode escrever ou remover outro user
      allow write: if false;
      allow delete: if false;
    }


    ///////////////////////////////////////////
    // 柏 4. Coleﾃｧﾃ｣o MUNICIPALITIES
    // /municipalities/{municipalityId}
    ///////////////////////////////////////////

    match /municipalities/{municipalityId} {

      // ADMIN pode tudo
      allow read, write: if isAdmin();

      // MASTER pode ler/escrever apenas dados da sua entidade
      allow read: if request.auth != null && resource.data.linkedEntityId == request.auth.token.entityId;
      allow create: if request.auth != null && request.resource.data.linkedEntityId == request.auth.token.entityId;
      allow update: if request.auth != null 
                    && resource.data.linkedEntityId == request.auth.token.entityId
                    && request.resource.data.linkedEntityId == request.auth.token.entityId;
      allow delete: if request.auth != null && resource.data.linkedEntityId == request.auth.token.entityId;
      
      // COORDENAﾃﾃグ pode ler (via linkedEntityId)
      allow read: if isCoordinationOf(resource.data.linkedEntityId);

      // SUBSEDE pode ler APENAS se linkedEntityId bater e municipalityId bater com token
      allow read: if isSubsedeOf(resource.data.linkedEntityId) 
                  && municipalityId == request.auth.token.municipalityId;

      // PUBLIC REGISTRATION: Allow read to resolve names (risk: scraping)
      allow read: if true;

      // 柏 ACTIONS (Subcollection for Dual Write)
      match /actions/{actionId} {
        // Master: Allow if they manage the Entity linked to this Action
        allow read, write: if isMasterOf(resource.data.entityId) 
                           || isMasterOf(request.resource.data.entityId);

        // Coordenaﾃｧﾃ｣o: Read
        allow read: if isCoordinationOf(resource.data.entityId);
        
        // Subsede: Read restricted to this Municipality
        allow read: if isSubsedeOf(resource.data.entityId) && municipalityId == request.auth.token.municipalityId;

        // Professional: Read
        allow read: if request.auth.token.role == "PROFESSIONAL" 
                    && request.auth.token.entityId == resource.data.entityId;

        // 柏 PRODUCTION (Sub-subcollection)
        match /production/{prodId} {
             allow read, write: if isMasterOf(request.resource.data.entityId) 
                                || isMasterOf(resource.data.entityId)
                                || isCoordinationOf(resource.data.entityId)
                                || (isSubsedeOf(resource.data.entityId) && municipalityId == request.auth.token.municipalityId)
                                || (request.auth.token.role == "PROFESSIONAL" && request.auth.token.entityId == (resource.data.entityId || request.resource.data.entityId));
        }
      }
    }

    ///////////////////////////////////////////
    // 柏 4.b. Coleﾃｧﾃ｣o MUNICIPALITIES (Nova Estrutura Hierﾃ｡rquica)
    // /municipalities/{entityType}/{entityId}/{municipalityId}
    ///////////////////////////////////////////

    match /municipalities/{entityType}/{entityId}/{municipalityId} {
        // ADMIN pode tudo na nova estrutura
        allow read, write: if isAdmin();
        
        // MASTER pode ver e editar apenas se o entityId da URL (path) bater com seu token
        allow read, write: if isMasterOf(entityId);
        
        // COORDENAﾃﾃグ pode ver apenas se o entityId bater
        allow read: if isCoordinationOf(entityId);

        // SUBSEDE pode ver apenas se o entityId bater E municipalityId bater
        allow read: if isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId;

        // PROFESSIONAL pode ler municﾃｭpios da sua entidade (para pegar config de interface)
        allow read: if request.auth.token.role == "PROFESSIONAL" 
                    && request.auth.token.entityId == entityId;
        
        // PUBLIC REGISTRATION: Allow read
        allow read: if true;

        // 柏 EXTRACTIONS (Dados do Conector - Nested)
        match /extractions/{extractionId} {
             // Admin, Master, Coordenaﾃｧﾃ｣o, Subsede (scoped)
             allow read: if isAdmin()
                         || isMasterOf(entityId)
                         || isCoordinationOf(entityId)
                         || (isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId);
        }

        // 柏 Records duplicados (Produﾃｧﾃ｣o)
        match /bpai_records/{unitId}/professionals/{professionalId}/competencias/{comp}/dates/{date}/pacientes/{patId}/procedures/{procId} {
             allow create: if isMasterOf(entityId)
                           || (request.auth.token.role == "PROFESSIONAL" 
                               && request.auth.token.professionalId == professionalId
                               && request.auth.token.entityId == entityId);
             allow read, update, delete: if isMasterOf(entityId)
                                         || isCoordinationOf(entityId)
                                         || (request.auth.token.role == "PROFESSIONAL" 
                                             && request.auth.token.professionalId == professionalId)
                                         // SUBSEDE (Read Only, Scoped)
                                         || (isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId);
        }

        // 柏 Professionals (Contextual Storage)
        match /professionals/{professionalId} {
             allow read: if isAdmin()
                         || isMasterOf(entityId)
                         || isCoordinationOf(entityId)
                         || (isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId)
                         || (request.auth.token.role == "PROFESSIONAL" && request.auth.token.professionalId == professionalId);
             
             allow create, update, delete: if isAdmin() 
                                           || isMasterOf(entityId);
                                           
             // PUBLIC REGISTRATION: Allow create (Sync Context)
             allow create: if true;
        }

        // 柏 Patients (New Scoped Collection)
        match /patients/{patientId} {
            allow read, write: if isAdmin()
                               || isMasterOf(entityId)
                               || isCoordinationOf(entityId)
                               || (isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId)
                               || (request.auth.token.role == "PROFESSIONAL" && request.auth.token.entityId == entityId);
        }

        // 柏 Goals (Nova Estrutura Hierﾃ｡rquica)
        // Match: municipalities/{entityType}/{entityId}/{municipalityId}/goals/{goalId} (Sem competencia - Legacy-ish migration?)
        // OR
        // municipalities/{entityType}/{entityId}/{municipalityId}/goals/{competence}/goals/{goalId}
        
        match /goals/{goalId} {
            // ADMIN
            allow read, write: if isAdmin();
            // MASTER
            allow read, write: if isMasterOf(entityId);
            // COORDENAﾃﾃグ
            allow read: if isCoordinationOf(entityId);
            // SUBSEDE
            allow read: if isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId;
            // PROFESSIONAL (Read Only)
            allow read: if request.auth.token.role == "PROFESSIONAL" && request.auth.token.entityId == entityId;
        }

        match /goals/{competence}/goals/{goalId} {
             // ADMIN
            allow read, write: if isAdmin();

            // MASTER
            // Check Entity + Municipality constraint
            allow read, write: if isMasterOf(entityId)
                               && (
                                  !('municipalityId' in request.auth.token) 
                                  || request.auth.token.municipalityId == null 
                                  || request.auth.token.municipalityId == municipalityId
                               );
            
            // COORDENAﾃﾃグ (Read Only)
            allow read: if isCoordinationOf(entityId);

            // SUBSEDE (Read Only)
            allow read: if isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId;

            // PROFESSIONAL (Read Only, scoped)
            allow read: if request.auth.token.role == "PROFESSIONAL"
                        && request.auth.token.entityId == entityId
                        && (
                           resource.data.professionalId == request.auth.token.professionalId
                           || (
                              (resource.data.professionalId == null || resource.data.professionalId == "team" || resource.data.professionalId == "") 
                              && resource.data.unitId == request.auth.token.unitId
                           )
                        );
                        
            match /progress/{progressId} {
                allow read, write: if isAdmin();
                
                allow read, write: if isMasterOf(entityId)
                                   && (
                                      !('municipalityId' in request.auth.token) 
                                      || request.auth.token.municipalityId == null 
                                      || request.auth.token.municipalityId == municipalityId
                                   );
                                   
                // Coordenaﾃｧﾃ｣o Read
                allow read: if isCoordinationOf(entityId);

                // Subsede Read
                allow read: if isSubsedeOf(entityId) && municipalityId == request.auth.token.municipalityId;

                // Professional: Create only (calculate progress)
                // Assuming professional can calculate progress for goals they can see.
                // Requirements say: "Atualizar Progresso" button is available.
                allow create: if request.auth.token.role == "PROFESSIONAL"
                              && request.auth.token.entityId == entityId
                              && (
                                 get(/databases/$(database)/documents/municipalities/$(entityType)/$(entityId)/$(municipalityId)/goals/$(competence)/goals/$(goalId)).data.professionalId == request.auth.token.professionalId
                                 || (
                                    get(/databases/$(database)/documents/municipalities/$(entityType)/$(entityId)/$(municipalityId)/goals/$(competence)/goals/$(goalId)).data.professionalId == null
                                    && get(/databases/$(database)/documents/municipalities/$(entityType)/$(entityId)/$(municipalityId)/goals/$(competence)/goals/$(goalId)).data.unitId == request.auth.token.unitId
                                 )
                              );
                              
                  allow read: if request.auth.token.role == "PROFESSIONAL"
                              && request.auth.token.entityId == entityId;
      }
    }

    // 柏 Support Tickets (Contextual)
    match /support_tickets/{ticketId} {
        allow create: if request.auth != null; 
        allow read: if isAdmin()
                    || isMasterOf(entityId)
                    || (request.auth.token.role == "PROFESSIONAL" && request.auth.token.professionalId == resource.data.userId)
                    // Allow simple User role match if userId is auth.uid 
                    || resource.data.userId == request.auth.uid;
    }
  }


    ///////////////////////////////////////////
    // 柏 5. Coleﾃｧﾃ｣o LICENSES (Admin)
    // /licenses/{licenseId}
    ///////////////////////////////////////////

    match /licenses/{licenseId} {
      allow read, write, delete: if isAdmin();
      
      match /installments/{installmentId} {
        allow read, write, delete: if isAdmin();
      }
    }


    ///////////////////////////////////////////
    // 柏 6. Coleﾃｧﾃ｣o UNITS
    // /units/{unitId}
    ///////////////////////////////////////////

    match /units/{unitId} {

      // ADMIN pode tudo
      allow read, write: if isAdmin();

      // MASTER pode ler / escrever unidades vinculadas ﾃ sua entidade
      allow read: if isMasterOf(resource.data.entityId);
      
      // COORDENAﾃﾃグ pode ler unidades vinculadas ﾃ sua entidade
      allow read: if isCoordinationOf(resource.data.entityId);

      // SUBSEDE pode ler unidades vinculadas ﾃ sua entidade
      // Note: We don't filter units by municipality here strictly for reading list, 
      // but UI filters them. Strict security would require checking unit municipality.
      // Assuming 'municipalityId' field exists on unit doc to filter properly if needed.
      // But requirement says "Nas demais abas, ele pode ver, mas sem mexer em nada".
      // Usually Unit list is just viewing. 
      // If we want to restrict visibility of Units to only those in the municipality:
      // allow read: if isSubsedeOf(resource.data.entityId) && resource.data.municipalityId == request.auth.token.municipalityId;
      // But existing Units doc might not have 'municipalityId' indexed or strictly required?
      // Let's check 'Units.tsx' / 'units' collection structure.
      // Assuming 'municipalityId' exists, we can enforce it.
      // IF we want to serve "Gestﾃ｣o Unidades", showing only relevant ones is better.
      allow read: if isSubsedeOf(resource.data.entityId); // Broader read for now to avoid breaking if field missing, filter in UI.

      // PROFESSIONAL: Needs to read unit details (type, name, etc) for context
      allow read: if request.auth.token.role == "PROFESSIONAL"; 
      // Ideally we would strictly filter by assignment, but since 'assignments' is complex in token/doc, 
      // allowing read of units is generally low risk (public info like address/name).
      // Stricter: if resource.data.entityId == request.auth.token.entityId;

      allow create: if request.auth != null
        && request.resource.data.entityId == request.auth.token.entityId;

      allow update, delete: if request.auth != null
        && resource.data.entityId == request.auth.token.entityId;

      // PUBLIC REGISTRATION: Allow read units (to select in form)
      allow read: if true;
    }


    ///////////////////////////////////////////
    // 柏 7. Coleﾃｧﾃ｣o PROFESSIONALS
    // /professionals/{professionalId}
    ///////////////////////////////////////////

    match /professionals/{professionalId} {
       allow read: if isAdmin() 
                   || (request.auth.token.role == "MASTER" && resource.data.entityId == request.auth.token.entityId) // <--- RESTORED THIS LINE
                   || (request.auth.token.role == "COORDENAﾃﾃグ" && resource.data.entityId == request.auth.token.entityId)
                   || (request.auth.token.role == "SUBSEDE" && resource.data.entityId == request.auth.token.entityId)
                   || (request.auth != null && request.auth.token.role == "PROFESSIONAL" && request.auth.token.professionalId == professionalId);
       
       // PUBLIC REGISTRATION: Allow create (Self-Registration)
       allow create: if true; // Validation logic should be in backend triggers ideally or limited here (e.g. active == true)
       
       allow create: if isAdmin() || (request.auth != null && request.auth.token.role == "MASTER" && request.resource.data.entityId == request.auth.token.entityId);
       allow update: if isAdmin() || (request.auth != null && request.auth.token.role == "MASTER" && resource.data.entityId == request.auth.token.entityId && request.resource.data.entityId == request.auth.token.entityId);
       allow delete: if isAdmin() || (request.auth != null && request.auth.token.role == "MASTER" && resource.data.entityId == request.auth.token.entityId);
    }

    ///////////////////////////////////////////
    // 柏 9. Coleﾃｧﾃｵes SIGTAP (Leitura Auth, Escrita Admin)
    ///////////////////////////////////////////

    match /sigtap/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Relaxed for testing
    }

    match /sigtap_import_history/{id} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Relaxed for testing
    }

    ///////////////////////////////////////////
    // 柏 10. Coleﾃｧﾃ｣o PATIENTS
    ///////////////////////////////////////////

    match /patients/{patientId} {
      // Allow any authenticated user to read/write patients for now
      // Ideally, we should restrict this to the user's entity or similar, 
      // but patients are often shared or global.
      allow read, write: if request.auth != null;
    }

    ///////////////////////////////////////////
    // 柏 11. Coleﾃｧﾃ｣o BPA_RECORDS
    ///////////////////////////////////////////

    match /bpa_records/{path=**}/procedures/{recordId} {
      // Helper functions for BPA ownership
      function isMasterOfEntity(data) {
        return request.auth.token.role == "MASTER" && data.entityId == request.auth.token.entityId;
      }
      function isCoordinationOfEntity(data) {
        return request.auth.token.role == "COORDENAﾃﾃグ" && data.entityId == request.auth.token.entityId;
      }
      function isSubsedeOfEntity(data) {
         return request.auth.token.role == "SUBSEDE" 
             && data.entityId == request.auth.token.entityId
             && data.municipalityId == request.auth.token.municipalityId;
      }
      function isProfessionalOwner(data) {
        // Check if the user is the professional linked to the record
        // Allow if data.professionalId matches Auth UID OR the professionalId claim
        return data.professionalId == request.auth.uid 
            || (request.auth.token.professionalId != null && data.professionalId == request.auth.token.professionalId);
      }

      // Create: Check new data
      allow create: if isAdmin() 
                    || isMasterOfEntity(request.resource.data)
                    || isProfessionalOwner(request.resource.data);
      
      // Read/Update/Delete: Check existing data
      allow read: if isAdmin()
                  || isMasterOfEntity(resource.data)
                  || isCoordinationOfEntity(resource.data)
                  || isSubsedeOfEntity(resource.data)
                  || isProfessionalOwner(resource.data);
                  
      allow update, delete: if isAdmin()
                            || isMasterOfEntity(resource.data)
                            || isProfessionalOwner(resource.data);
    }

    // BPA-C Consolidated Records
    match /bpa_records/BPA-C/{document=**} {
      allow read, write: if request.auth != null;
    }

    ///////////////////////////////////////////
    // 柏 12. Collection Group: PROCEDURES (New) & REGISTROS (Legacy)
    ///////////////////////////////////////////
    match /{path=**}/installments/{installmentId} {
      allow read: if isAdmin();
    }
    
    match /{path=**}/procedures/{recordId} {
      allow read: if isAdmin() 
                  || (request.auth.token.role == "MASTER" && resource.data.entityId == request.auth.token.entityId)
                  || (request.auth.token.role == "COORDENAﾃﾃグ" && resource.data.entityId == request.auth.token.entityId)
                  || (request.auth.token.role == "SUBSEDE" && resource.data.entityId == request.auth.token.entityId && resource.data.municipalityId == request.auth.token.municipalityId)
                  || (request.auth.token.role == "PROFESSIONAL" && (
                      resource.data.professionalId == request.auth.uid
                      || (request.auth.token.professionalId != null && resource.data.professionalId == request.auth.token.professionalId)
                  ))
                  // Allow if user has entityId claim matching resource (broader check for safety)
                  || (request.auth.token.entityId == resource.data.entityId);
    }

    match /{path=**}/registros/{recordId} {
      allow read: if isAdmin() 
                  || (request.auth.token.role == "MASTER" && resource.data.entityId == request.auth.token.entityId)
                  || (request.auth.token.role == "COORDENAﾃﾃグ" && resource.data.entityId == request.auth.token.entityId)
                  || (request.auth.token.role == "SUBSEDE" && resource.data.entityId == request.auth.token.entityId && resource.data.municipalityId == request.auth.token.municipalityId)
                  || (request.auth.token.role == "PROFESSIONAL" && resource.data.professionalId == request.auth.uid);
    }

    // SIGTAP Collection Group (Public Read for Auth)
    match /{path=**}/procedimentos/{procedureId} {
      allow read: if request.auth != null;
    }

    ///////////////////////////////////////////
    // 柏 13. Coleﾃｧﾃ｣o LEDI_BATCHES
    ///////////////////////////////////////////

    match /ledi_batches/{batchId} {
      allow read, write: if isAdmin();
      
      // Logs Subcollection
      match /logs/{logId} {
        allow read, write: if isAdmin();
      }
    }

    ///////////////////////////////////////////
    // 柏 14. Coleﾃｧﾃ｣o GOALS
    // /goals/{goalId}
    ///////////////////////////////////////////

    ///////////////////////////////////////////
    // 柏 14. Coleﾃｧﾃ｣o GOALS (Nested & Collection Group)
    // match /{path=**}/goals/{goalId}
    ///////////////////////////////////////////

    match /{path=**}/goals/{goalId} {
      
      function isMasterReader(data) {
        return request.auth.token.role == "MASTER" 
            && data.entityId == request.auth.token.entityId
            && (
              request.auth.token.get('municipalityId', null) == null
              || request.auth.token.get('municipalityId', '') == ''
              || data.municipalityId == request.auth.token.municipalityId
            );
      }
      
      function isCoordinationReader(data) {
        return request.auth.token.role == "COORDENAﾃﾃグ" 
            && data.entityId == request.auth.token.entityId;
      }

      function isSubsedeReader(data) {
        return request.auth.token.role == "SUBSEDE" 
            && data.entityId == request.auth.token.entityId
            && data.municipalityId == request.auth.token.municipalityId;
      }

      function isProfessionalReader(data) {
        return request.auth.token.role == "PROFESSIONAL"
            && data.entityId == request.auth.token.entityId
            // Removed strict municipalityId check because token claim might not match context
            // && data.municipalityId == request.auth.token.municipalityId
            && (
               data.professionalId == request.auth.token.professionalId
               || (
                  (data.professionalId == null || data.professionalId == "team" || data.professionalId == "") 
                  && data.unitId == request.auth.token.unitId
               )
            );
      }

      // READ: Admin, Master (scoped), Professional (scoped), COORDENAﾃﾃグ, SUBSEDE
      allow read: if isAdmin()
                  || isMasterReader(resource.data)
                  || isCoordinationReader(resource.data)
                  || isSubsedeReader(resource.data)
                  || isProfessionalReader(resource.data);

      // WRITE: Admin, Master (scoped)
      // Professional is EXPLICITLY EXCLUDED (Read-only)
      allow create: if isAdmin()
                    || isMasterReader(request.resource.data);
                    
      allow update, delete: if isAdmin()
                            || isMasterReader(resource.data);

      // Subcollection PROGRESS
      match /progress/{progressId} {
          allow read: if isAdmin()
                      || isMasterReader(get(/databases/$(database)/documents/$(path)/goals/$(goalId)).data)
                      || isCoordinationReader(get(/databases/$(database)/documents/$(path)/goals/$(goalId)).data)
                      || isSubsedeReader(get(/databases/$(database)/documents/$(path)/goals/$(goalId)).data)
                      || isProfessionalReader(get(/databases/$(database)/documents/$(path)/goals/$(goalId)).data);
          
          allow create: if isAdmin()
                        || isMasterReader(get(/databases/$(database)/documents/$(path)/goals/$(goalId)).data);
      }
    }



    ///////////////////////////////////////////
    // 柏 15. Coleﾃｧﾃ｣o USERS (Entity Users)
    // /users/{userId}
    ///////////////////////////////////////////

    match /users/{userId} {
      allow read: if isAdmin()
                  || isMasterOf(resource.data.entityId)
                  || (request.auth.token.role == "COORDENAﾃﾃグ" && resource.data.entityId == request.auth.token.entityId)
                  // Allow self read
                  || request.auth.uid == userId;
                  
      // Write is handled primarily by Cloud Functions (Admin SDK), 
      // but if we ever needed direct write (not recommended):
      allow write: if false; 
    }

    ///////////////////////////////////////////
    // 柏 16. Coleﾃｧﾃ｣o SUPPORT_TICKETS (Root)
    ///////////////////////////////////////////

    match /support_tickets/{ticketId} {
      // Create: Authenticated users can open tickets
      allow create: if request.auth != null;
      
      // Read/Update: Admins OR the creator
      allow read, update: if isAdmin() 
                          || (request.auth != null && resource.data.userId == request.auth.uid)
                          || (request.auth != null && resource.data.userEmail == request.auth.token.email);
    }
    
    ///////////////////////////////////////////
    // 柏 17. Coleﾃｧﾃ｣o LOGS (Collection Group & Nested)
    ///////////////////////////////////////////
    
    match /{path=**}/logs/{logId} {
        // ADMIN
        allow read, write: if isAdmin();

        // MASTER
        allow create: if isMasterOf(request.resource.data.entityId);
        allow read: if isMasterOf(resource.data.entityId);

        // COORDENAﾃﾃグ
        allow create: if isCoordinationOf(request.resource.data.entityId);
        allow read: if isCoordinationOf(resource.data.entityId);

        // SUBSEDE
        allow create: if isSubsedeOf(request.resource.data.entityId);
        allow read: if isSubsedeOf(resource.data.entityId) 
                    && (resource.data.municipalityId == null || resource.data.municipalityId == request.auth.token.municipalityId);

        // PROFESSIONAL
        // Professionals can log actions they perform (Create)
        allow create: if request.auth.token.role == "PROFESSIONAL" 
                      && request.resource.data.entityId == request.auth.token.entityId;
        
        // Professionals can Read? Generally logs are for managers. 
        // If we want Professionals to see THEIR actions, we can add that.
        // But for now, Requirements imply Entity Panel usage (Managers).
        // Let's allow Professionals to Log (Create) but maybe not read all.
        // However, if the UI is exposed to them, they need read. 
        // Assuming Logs page is protected by Role in UI?
        // Layout shows Logs for everyone in private. 
        // Let's allow read if Professional matches entity.
        allow read: if request.auth.token.role == "PROFESSIONAL" 
                    && resource.data.entityId == request.auth.token.entityId;

        // PUBLIC REGISTRATION: Allow create log
        allow create: if true;

        // AUTH users (Generic Fallback for Login/Logout which might not imply role yet?)
        // Login logs happen AFTER auth, so token exists.
        // We can allow any authenticated user to create a log if they provide valid context.
        allow create: if request.auth != null && request.resource.data.entityId == request.auth.token.entityId;
    }
    
    ///////////////////////////////////////////
    // 柏 18. Coleﾃｧﾃ｣o EXTRACTED_PRODUCTION (Dados do Conector)
    ///////////////////////////////////////////

    match /extracted_production/{docId} {
      // Helper to fetch municipality and check ownership
      function checkMunicipalityAccess() {
        let munId = resource.data.municipalityId;
        let munDoc = get(/databases/$(database)/documents/municipalities/$(munId));
        return isMasterOf(munDoc.data.linkedEntityId) 
            || isCoordinationOf(munDoc.data.linkedEntityId)
            || (isSubsedeOf(munDoc.data.linkedEntityId) && request.auth.token.municipalityId == munId);
      }

      allow read: if isAdmin() || checkMunicipalityAccess();
      // Write is restricted to Cloud Functions (Admin SDK) usually, or authenticated ingestion if via Client SDK (but we use REST API)
      // So no write rules needed for client.
    }

    match /{path=**} {
      allow read, write: if false;
    }
  }
}